<app-title [content]="title" [borderEnabled]="true" />
<div class="generic-table-container">
  <p-table
    [value]="_data"
    [dataKey]="identifier"
    styleClass="p-datatable-striped p-datatable-sm"
    [paginator]="true"
    [rows]="10"
    [showCurrentPageReport]="true"
    [tableStyle]="{ 'min-width': '100%' }"
    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
    [rowsPerPageOptions]="[10, 25, 50]"
    [globalFilterFields]="globalFilterFields"
    [(selection)]="selectedRow"
    selectionMode="single"
    [columns]="cols"
    [exportHeader]="'customExportHeader'"
    [expandedRowKeys]="expandedRows"
    [scrollable]="true"
    [resizableColumns]="true"
    columnResizeMode="expand"
    scrollHeight="800px"
    #table>
    <ng-template pTemplate="caption">
      <div #caption>
        <app-generic-caption
          [globalFilterEnabled]="true"
          [exportTableEnabled]="true"
          [globalFilter]="globalFilter"
          (clearFilter)="clear(table)"
          [table]="table"
          [exportName]="title"
          [exportsAvailable]="['XLSX', 'CSV']" />
      </div>
    </ng-template>

    <ng-template pTemplate="header">
      <tr>
        @for (header of cols; track header.field) {
          @if (!header.hidden) {
            @switch (header.dataType) {
              @case ('datetime') {
                <th [pSortableColumn]="header.field" pResizableColumn style="width: 210px; max-width: 210px">
                  <div class="th-content">
                    <span class="label-header"> {{ header.header }} </span>
                    <p-sortIcon [field]="header.field"></p-sortIcon>
                  </div>
                </th>
              }
              @case ('number') {
                <th
                  [pSortableColumn]="header.field"
                  pResizableColumn
                  style="width: 172px; max-width: 172px"
                  [ngClass]="{ 'number-long': header.field === 'BackendResponseCode' }">
                  <div class="th-content">
                    <span class="label-header"> {{ header.header }} </span>
                    <p-sortIcon [field]="header.field"></p-sortIcon>
                  </div>
                </th>
              }
              @case ('button') {
                <th [pSortableColumn]="header.field" pResizableColumn style="width: 64px">
                  <div class="th-content">
                    <span class="label-header"> {{ header.header }} </span>
                    <p-sortIcon [field]="header.field"></p-sortIcon>
                  </div>
                </th>
              }
              @default {
                <th
                  [pSortableColumn]="header.field"
                  pResizableColumn
                  [style]="
                    header.field === 'apiKey'
                      ? 'width: 140px; max-width: 140px;'
                      : header.field === 'transactionId'
                        ? 'width: 175px; max-width: 175px;'
                        : header.field === 'subscriptionId'
                          ? 'width: 187px; max-width: 187px;'
                          : header.field === 'method'
                            ? 'width: 150px; max-width: 150px;'
                            : 'min-width: 240px;'
                  ">
                  <div class="th-content">
                    <span class="label-header"> {{ header.header }} </span>

                    <p-sortIcon [field]="header.field"></p-sortIcon>
                  </div>
                </th>
              }
            }
          }
        }
      </tr>
      @if (filtersEnabled) {
        <tr class="filter-row">
          @for (column of cols; track column.field) {
            @switch (column.filterMode) {
              @case ('text') {
                <th>
                  <div>
                    <p-columnFilter
                      type="text"
                      [field]="column.field"
                      [placeholder]="'Search by ' + column.header"
                      [ariaLabel]="'Filter ' + column.header" />
                  </div>
                </th>
              }
              @case ('dropdown') {
                <th>
                  <div>
                    <p-columnFilter [field]="column.field" matchMode="in" [showMenu]="false">
                      <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                        <p-multiSelect
                          [ngModel]="value"
                          [options]="column.filterOptions"
                          placeholder="Any"
                          [filter]="false"
                          (onChange)="filter($event.value)">
                        </p-multiSelect>
                      </ng-template>
                    </p-columnFilter>
                  </div>
                </th>
              }
              @default {
                <th></th>
              }
            }
          }
        </tr>
      }
    </ng-template>

    <ng-template pTemplate="sorticon" field="col.field" let-sortOrder>
      <app-generic-sort-icon-parker [sortOrder]="sortOrder"></app-generic-sort-icon-parker>
    </ng-template>

    <ng-template pTemplate="rowexpansion" let-element>
      <tr>
        <td [attr.colspan]="'100%'" class="expanded-container">
          <div [style]="'max-width: calc(' + captionWidth + 'px - 2rem)'">
            <app-generic-expanded-row
              [data]="expandedData"
              [globalFilterValue]="globalFilter.value"></app-generic-expanded-row>
          </div>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-element let-expanded="expanded">
      <tr>
        @for (header of cols; track header.field) {
          @if (!header.hidden) {
            @switch (header.dataType) {
              @case ('datetime') {
                <td
                  [pSelectableRow]="element"
                  (click)="toggleRow(element, header.field)"
                  [ngClass]="{
                    'selected-field': selectedField === header.field,
                    'selected-id': rowIdExpanded === element[identifier],
                  }">
                  <div
                    class="ellipsis-overflow"
                    [innerHTML]="element[header.field] | highlightSearch: globalFilter.value"></div>
                </td>
              }
              @case ('button') {
                @if (header.field === 'json') {
                  <td>
                    <div class="td-button">
                      <app-generic-details-button [data]="element"></app-generic-details-button>
                    </div>
                  </td>
                }
              }
              @default {
                <td
                  [pSelectableRow]="element"
                  (click)="toggleRow(element, header.field)"
                  [ngClass]="{
                    'selected-field': selectedField === header.field,
                    'selected-id': rowIdExpanded === element[identifier],
                  }">
                  <div
                    class="ellipsis-overflow"
                    [innerHTML]="element[header.field] | highlightSearch: globalFilter.value"></div>
                </td>
              }
            }
          }
        }
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="100%">No elements were found.</td>
      </tr>
    </ng-template>
  </p-table>
</div>
